<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Bandrol Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    
    <style>
        :root { --navy-dark: #343f52; --light-bg: #f8f9fa; }
        body { background-color: var(--light-bg); font-family: sans-serif; overflow-x: hidden; }
        
        /* Navbar & Header */
        .navbar { background-color: white; border-bottom: 1px solid #eee; padding: 10px 15px; }
        .navbar-toggler { border: none !important; outline: none !important; box-shadow: none !important; padding: 0 !important; }
        .navbar-toggler-icon { width: 1.6rem; height: 1.6rem; }
        .header-title { font-weight: bold; color: var(--navy-dark); font-size: 1.15rem; }

        /* Sidebar */
        .offcanvas { width: 260px !important; border: none; }
        .offcanvas-body { padding-top: 0 !important; }
        .menu-item { display: block; padding: 18px 25px; text-decoration: none; font-weight: bold; font-size: 15px; text-align: left; color: var(--navy-dark); }
        .menu-beranda { border-bottom: 1px solid #eee; margin-top: 0 !important; }
        .menu-logout { color: #e74c3c; }

        /* Table Styling */
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .table-responsive { border-radius: 10px; background: white; border: 1px solid #eee; max-height: 500px; overflow-x: auto; }
        .table thead th { background-color: #fcfcfc; color: #999; font-size: 11px; text-transform: uppercase; padding: 12px; white-space: nowrap; }
        .table td { padding: 12px; vertical-align: middle; border-bottom: 1px solid #f9f9f9; font-size: 12px; white-space: nowrap; }
        .col-deskripsi { min-width: 350px; white-space: normal !important; font-weight: bold; color: #222; }

        /* NOTIFIKASI TOAST (Melayang di bawah) */
        .toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; }
        .my-toast { 
            background: rgba(33, 37, 41, 0.9); color: white; padding: 12px 24px; 
            border-radius: 50px; font-size: 13px; font-weight: bold; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none;
            text-align: center; min-width: 200px;
        }

        .search-wrapper { position: relative; }
        .btn-clear { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #ddd; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; }
        #camera-preview { width: 100%; max-width: 400px; display: none; border: 3px solid var(--navy-dark); border-radius: 10px; margin: 10px auto; }
        .loader { display: none; font-size: 14px; color: var(--navy-dark); font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<div class="toast-container">
    <div id="toastNotif" class="my-toast"></div>
</div>

<nav class="navbar sticky-top">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar">
            <span class="navbar-toggler-icon"></span>
        </button>
        <span class="header-title mx-auto">TAHAP PERCOBAAN</span>
        <div style="width: 40px;"></div> 
    </div>
</nav>

<div class="offcanvas offcanvas-start" id="sidebar">
    <div class="offcanvas-body">
        <a href="index.html" class="menu-item menu-beranda">BERANDA</a>
        <a href="index.html" class="menu-item menu-logout">LOGOUT</a>
    </div>
</div>

<div class="container-fluid py-3">
    <div class="card p-3 shadow-sm">
        <div class="row g-2 align-items-end mb-4">
            <div class="col-6 col-sm-auto">
                <label class="form-label mb-1 small fw-bold">Planogram:</label>
                <select class="form-select form-select-sm" id="planoSelect" onchange="doSearch(true)">
                    <option value="AK1">AK1</option>
                    <option value="AK2">AK2</option>
                </select>
            </div>
            
            <div class="col-12 col-sm-auto">
                <label class="form-label mb-1 small fw-bold">Cari Deskripsi:</label>
                <div class="search-wrapper">
                    <input type="text" id="searchNama" class="form-control form-control-sm" placeholder="Nama..." onkeyup="doSearch()">
                    <button class="btn-clear" onclick="resetInput('searchNama')">&times;</button>
                </div>
            </div>

            <div class="col-12 col-sm-auto">
                <label class="form-label mb-1 small fw-bold">Cari Kode / Scan:</label>
                <div class="search-wrapper d-flex gap-1">
                    <input type="text" id="searchKode" class="form-control form-control-sm" placeholder="Kode..." onkeyup="doSearch()">
                    <button class="btn btn-primary btn-sm" onclick="toggleCam()">üì∑</button>
                </div>
            </div>
            
            <div class="col-12 col-sm text-end">
                <div class="btn-group">
                    <button class="btn btn-light border btn-sm dropdown-toggle" data-bs-toggle="dropdown">IMPORT</button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item fw-bold" href="#" onclick="triggerImport('AK1')">AK1</a></li>
                        <li><a class="dropdown-item fw-bold" href="#" onclick="triggerImport('AK2')">AK2</a></li>
                    </ul>
                </div>
                <div class="btn-group">
                    <button class="btn btn-light border btn-sm dropdown-toggle" data-bs-toggle="dropdown">EXPORT</button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item fw-bold" href="#" onclick="runExport('AK1')">AK1</a></li>
                        <li><a class="dropdown-item fw-bold" href="#" onclick="runExport('AK2')">AK2</a></li>
                    </ul>
                </div>
                <button class="btn btn-danger btn-sm" onclick="clearAll()">HAPUS</button>
                <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
            </div>
        </div>

        <div class="text-center">
            <video id="camera-preview" autoplay playsinline></video>
            <canvas id="hidden-canvas" style="display:none;"></canvas>
            <div id="loader" class="loader">üîç Sedang Membaca...</div>
            <button id="btn-capture" class="btn btn-success btn-sm mb-3 w-100" style="display:none; max-width:400px;" onclick="takePhoto()">AMBIL FOTO</button>
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead>
                    <tr>
                        <th class="text-center">No</th>
                        <th>Kode</th>
                        <th>Barcode</th>
                        <th class="col-deskripsi">Deskripsi Produk</th>
                        <th>Ukuran</th>
                        <th class="text-center">Selving</th>
                        <th class="text-center">Baris</th>
                        <th class="text-center">Planogram</th>
                    </tr>
                </thead>
                <tbody id="mainTableBody"></tbody>
            </table>
        </div>
        <div id="infoRow" class="mt-2 text-muted fw-bold small"></div>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('mbData')) || [];
    let camStream = null;
    let importTarget = "";
    let toastTimeout;

    // FUNGSI NOTIFIKASI UNIVERSAL
    function showNotif(msg) {
        const toast = document.getElementById('toastNotif');
        toast.innerText = msg;
        toast.style.display = 'block';
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => { toast.style.display = 'none'; }, 2500);
    }

    function refreshTable() {
        const body = document.getElementById('mainTableBody');
        body.innerHTML = db.map((it, idx) => `
            <tr>
                <td class="text-center">${idx + 1}</td>
                <td>${it.kode}</td>
                <td>${it.barcode || '-'}</td>
                <td class="col-deskripsi">${it.nama}</td>
                <td>${it.ukuran || '-'}</td>
                <td class="text-center">${it.selving || '-'}</td>
                <td class="text-center">${it.baris || '-'}</td>
                <td class="text-center">${it.planogram || '-'}</td>
            </tr>
        `).join('');
        doSearch(false);
    }

    function doSearch(isUserAction = false) {
        const p = document.getElementById('planoSelect').value.toUpperCase();
        const n = document.getElementById('searchNama').value.toUpperCase();
        const k = document.getElementById('searchKode').value.toUpperCase();
        const rows = document.querySelectorAll('#mainTableBody tr');
        let count = 0;

        rows.forEach(r => {
            const match = (r.cells[7].innerText.toUpperCase() === p) && 
                          (r.cells[3].innerText.toUpperCase().includes(n)) && 
                          (r.cells[1].innerText.toUpperCase().includes(k) || r.cells[2].innerText.toUpperCase().includes(k));
            r.style.display = match ? '' : 'none';
            if(match) count++;
        });

        document.getElementById('infoRow').innerText = `TOTAL: ${count} ITEM (${p})`;
        
        // Notifikasi saat ganti planogram
        if(isUserAction) showNotif("Menampilkan Planogram " + p);
    }

    function resetInput(id) { 
        document.getElementById(id).value = ''; 
        doSearch(); 
        showNotif("Pencarian dibersihkan");
    }

    function triggerImport(plano) {
        importTarget = plano;
        document.getElementById('fileInput').click();
    }

    document.getElementById('fileInput').onchange = function(e) {
        const reader = new FileReader();
        showNotif("Sedang memproses file...");
        reader.onload = function(evt) {
            try {
                const data = new Uint8Array(evt.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const newData = json.map(row => ({
                    kode: String(row["Kode Barang"] || row["kode_barang"] || ""),
                    barcode: String(row["Barcode"] || row["barcode"] || ""),
                    nama: String(row["Deskripsi Produk"] || row["deskripsi_produk"] || ""),
                    ukuran: String(row["Ukuran"] || row["ukuran"] || ""),
                    selving: String(row["Selving"] || row["selving"] || ""),
                    baris: String(row["Baris"] || row["baris"] || ""),
                    planogram: importTarget
                }));
                db = [...db, ...newData];
                localStorage.setItem('mbData', JSON.stringify(db));
                refreshTable();
                showNotif("‚úÖ Berhasil Import ke " + importTarget);
            } catch (err) {
                showNotif("‚ùå Gagal membaca file Excel");
            }
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    function runExport(plano) {
        const filtered = db.filter(it => it.planogram === plano);
        if(!filtered.length) {
            showNotif("‚ùå Data " + plano + " masih kosong");
            return;
        }
        const ws = XLSX.utils.json_to_sheet(filtered);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        XLSX.writeFile(wb, `${plano}.xlsx`);
        showNotif("üöÄ Berhasil Export " + plano);
    }

    async function toggleCam() {
        const vid = document.getElementById('camera-preview');
        const btnSnap = document.getElementById('btn-capture');
        if (camStream) {
            camStream.getTracks().forEach(t => t.stop()); camStream = null;
            vid.style.display = 'none'; btnSnap.style.display = 'none';
            showNotif("Kamera ditutup");
        } else {
            try {
                showNotif("Membuka Kamera...");
                camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                vid.srcObject = camStream; vid.style.display = 'block'; btnSnap.style.display = 'block';
            } catch (e) { showNotif("‚ùå Akses Kamera Ditolak"); }
        }
    }

    function takePhoto() {
        const vid = document.getElementById('camera-preview');
        const canvas = document.getElementById('hidden-canvas');
        const loader = document.getElementById('loader');
        canvas.width = vid.videoWidth; canvas.height = vid.videoHeight;
        canvas.getContext('2d').drawImage(vid, 0, 0);
        
        loader.style.display = 'block';
        showNotif("Sedang menganalisa teks...");
        
        Tesseract.recognize(canvas.toDataURL(), 'eng').then(({ data: { text } }) => {
            const match = text.match(/\d+/); 
            if (match) { 
                document.getElementById('searchKode').value = match[0]; 
                doSearch(); 
                toggleCam();
                showNotif("‚úÖ Kode ditemukan: " + match[0]);
            } else {
                showNotif("‚ùå Teks tidak terbaca, coba lagi");
            }
        }).finally(() => { loader.style.display = 'none'; });
    }

    function clearAll() {
        if(confirm("Hapus seluruh database?")) { 
            db = []; 
            localStorage.removeItem('mbData'); 
            refreshTable(); 
            showNotif("üóëÔ∏è Seluruh data telah dihapus");
        }
    }

    window.onload = refreshTable;
</script>
</body>
</html>
