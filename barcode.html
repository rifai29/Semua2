<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Bandrol Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    
    <style>
        :root { --navy-dark: #343f52; --light-bg: #f8f9fa; }
        body { background-color: var(--light-bg); font-family: sans-serif; overflow-x: hidden; }
        
        /* Navbar & Header */
        .navbar { background-color: white; border-bottom: 1px solid #eee; padding: 10px 15px; }
        .navbar-toggler { border: none !important; outline: none !important; box-shadow: none !important; }
        .header-title { font-weight: bold; color: var(--navy-dark); font-size: 1.15rem; }

        /* Sidebar Styling */
        .offcanvas { width: 260px !important; border: none; }
        .offcanvas-body { padding: 0 !important; }
        .menu-item { display: block; padding: 18px 25px; text-decoration: none; font-weight: bold; font-size: 15px; text-align: left; color: var(--navy-dark); border-bottom: 1px solid #eee; }
        .menu-logout { color: #e74c3c !important; }

        /* Table Styling */
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .table-responsive { border-radius: 10px; background: white; border: 1px solid #eee; max-height: 500px; overflow-x: auto; }
        .table thead th { background-color: #fcfcfc; color: #999; font-size: 11px; text-transform: uppercase; padding: 12px; white-space: nowrap; }
        .table td { padding: 12px; vertical-align: middle; border-bottom: 1px solid #f9f9f9; font-size: 12px; white-space: nowrap; }
        .col-deskripsi { min-width: 350px; white-space: normal !important; font-weight: bold; color: #222; }

        /* NOTIFIKASI TOAST */
        .toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; }
        .my-toast { 
            background: rgba(33, 37, 41, 0.9); color: white; padding: 12px 24px; 
            border-radius: 50px; font-size: 13px; font-weight: bold; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none;
            text-align: center; min-width: 200px;
        }

        /* Search Wrapper with Clear Button */
        .search-wrapper { position: relative; display: flex; align-items: center; width: 100%; }
        .btn-clear { 
            position: absolute; right: 8px; background: #ddd; border: none; 
            border-radius: 50%; width: 18px; height: 18px; font-size: 10px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            color: #555; z-index: 10;
        }

        /* Camera Area */
        #camera-preview { width: 100%; max-width: 400px; display: none; border: 3px solid var(--navy-dark); border-radius: 10px; margin: 10px auto; }
        .loader { display: none; font-size: 14px; color: var(--navy-dark); font-weight: bold; text-align: center; }
        .badge-plano { background-color: #eef2f7; color: #343f52; border: 1px solid #d1d9e6; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="toast-container">
    <div id="toastNotif" class="my-toast"></div>
</div>

<nav class="navbar sticky-top">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
        <span class="header-title mx-auto">TAHAP PERCOBAAN</span>
        <div style="width: 40px;"></div> 
    </div>
</nav>

<div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu">
    <div class="offcanvas-body">
        <a href="#" class="menu-item">BERANDA</a>
        <a href="#" class="menu-item menu-logout" onclick="clearAll()">HAPUS DATABASE</a>
    </div>
</div>

<div class="container-fluid py-3">
    <div class="card p-3 shadow-sm">
        <div class="row g-2 align-items-end mb-4">
            
            <div class="col-6 col-md-2">
                <label class="form-label mb-1 small fw-bold">Pilih Rak:</label>
                <select class="form-select form-select-sm" id="planoSelect" onchange="doSearch(true)">
                    <option value="">-- SEMUA RAK --</option>
                </select>
            </div>
            
            <div class="col-6 col-md-3">
                <label class="form-label mb-1 small fw-bold">Cari Deskripsi:</label>
                <div class="search-wrapper">
                    <input type="text" id="searchNama" class="form-control form-control-sm" placeholder="Nama..." onkeyup="doSearch()">
                    <button class="btn-clear" onclick="resetInput('searchNama')">&times;</button>
                </div>
            </div>

            <div class="col-12 col-md-3">
                <label class="form-label mb-1 small fw-bold">Cari Kode / Scan:</label>
                <div class="d-flex gap-1">
                    <div class="search-wrapper flex-grow-1">
                        <input type="text" id="searchKode" class="form-control form-control-sm" placeholder="Kode..." onkeyup="doSearch()">
                        <button class="btn-clear" onclick="resetInput('searchKode')">&times;</button>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="toggleCam()">üì∑</button>
                </div>
            </div>
            
            <div class="col-12 col-md text-md-end">
                <button class="btn btn-success btn-sm fw-bold" onclick="document.getElementById('fileInput').click()">IMPORT EXCEL</button>
                <button class="btn btn-light border btn-sm" onclick="runExport()">EXPORT</button>
                <button class="btn btn-danger btn-sm" onclick="clearAll()">HAPUS</button>
                <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
            </div>
        </div>

        <div class="text-center">
            <video id="camera-preview" autoplay playsinline></video>
            <canvas id="hidden-canvas" style="display:none;"></canvas>
            <div id="loader" class="loader">üîç Sedang Membaca...</div>
            <button id="btn-capture" class="btn btn-success btn-sm mb-3 w-100" style="display:none; max-width:400px;" onclick="takePhoto()">AMBIL FOTO</button>
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead>
                    <tr>
                        <th class="text-center">No</th>
                        <th>Kode</th>
                        <th>Barcode</th>
                        <th class="col-deskripsi">Deskripsi Produk</th>
                        <th>Ukuran</th>
                        <th class="text-center">Selving</th>
                        <th class="text-center">Baris</th>
                        <th class="text-center">Planogram</th>
                    </tr>
                </thead>
                <tbody id="mainTableBody"></tbody>
            </table>
        </div>
        <div id="infoRow" class="mt-2 text-muted fw-bold small"></div>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('mbData')) || [];
    let camStream = null;
    let toastTimeout;

    function showNotif(msg) {
        const toast = document.getElementById('toastNotif');
        toast.innerText = msg;
        toast.style.display = 'block';
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => { toast.style.display = 'none'; }, 2500);
    }

    function updatePlanoDropdown() {
        const select = document.getElementById('planoSelect');
        const currentVal = select.value;
        const uniquePlanos = [...new Set(db.map(it => it.planogram))].filter(Boolean).sort();
        
        let options = '<option value="">-- SEMUA RAK --</option>';
        uniquePlanos.forEach(p => {
            options += `<option value="${p}" ${p === currentVal ? 'selected' : ''}>${p}</option>`;
        });
        select.innerHTML = options;
    }

    function refreshTable() {
        updatePlanoDropdown();
        const body = document.getElementById('mainTableBody');
        body.innerHTML = db.map((it, idx) => `
            <tr>
                <td class="text-center">${idx + 1}</td>
                <td>${it.kode}</td>
                <td>${it.barcode || '-'}</td>
                <td class="col-deskripsi">${it.nama}</td>
                <td>${it.ukuran || '-'}</td>
                <td class="text-center">${it.selving || '-'}</td>
                <td class="text-center">${it.baris || '-'}</td>
                <td class="text-center"><span class="badge-plano">${it.planogram || '-'}</span></td>
            </tr>
        `).join('');
        doSearch(false);
    }

    function doSearch(isUserAction = false) {
        const p = document.getElementById('planoSelect').value.toUpperCase();
        const n = document.getElementById('searchNama').value.toUpperCase();
        const k = document.getElementById('searchKode').value.toUpperCase();
        const rows = document.querySelectorAll('#mainTableBody tr');
        let count = 0;

        rows.forEach(r => {
            const rowPlano = r.cells[7].innerText.toUpperCase();
            const rowNama = r.cells[3].innerText.toUpperCase();
            const rowKode = r.cells[1].innerText.toUpperCase();
            const rowBarcode = r.cells[2].innerText.toUpperCase();

            const match = (p === "" || rowPlano === p) && 
                          (rowNama.includes(n)) && 
                          (rowKode.includes(k) || rowBarcode.includes(k));
            
            r.style.display = match ? '' : 'none';
            if(match) count++;
        });

        document.getElementById('infoRow').innerText = `TOTAL: ${count} ITEM`;
    }

    function resetInput(id) { 
        document.getElementById(id).value = ''; 
        doSearch(); 
    }

    document.getElementById('fileInput').onchange = function(e) {
        const reader = new FileReader();
        showNotif("Menganalisa File...");
        reader.onload = function(evt) {
            try {
                const data = new Uint8Array(evt.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                const newData = json.map(row => ({
                    kode: String(row["Kode Barang"] || row["kode"] || ""),
                    barcode: String(row["Barcode"] || row["barcode"] || ""),
                    nama: String(row["Deskripsi Produk"] || row["nama"] || ""),
                    ukuran: String(row["Ukuran"] || row["ukuran"] || ""),
                    selving: String(row["Selving"] || row["selving"] || ""),
                    baris: String(row["Baris"] || row["baris"] || ""),
                    planogram: String(row["Planogram"] || row["Rak"] || "UNSET").toUpperCase()
                }));

                db = [...db, ...newData];
                localStorage.setItem('mbData', JSON.stringify(db));
                refreshTable();
                showNotif("‚úÖ Berhasil Impor " + newData.length + " data");
            } catch (err) {
                showNotif("‚ùå Gagal Impor File");
            }
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    function runExport() {
        const p = document.getElementById('planoSelect').value;
        const dataToExport = p ? db.filter(it => it.planogram === p) : db;
        if(!dataToExport.length) return showNotif("Data Kosong");
        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        XLSX.writeFile(wb, `Export_${p || 'Semua'}.xlsx`);
    }

    async function toggleCam() {
        const vid = document.getElementById('camera-preview');
        const btnSnap = document.getElementById('btn-capture');
        if (camStream) {
            camStream.getTracks().forEach(t => t.stop()); camStream = null;
            vid.style.display = 'none'; btnSnap.style.display = 'none';
        } else {
            try {
                camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                vid.srcObject = camStream; vid.style.display = 'block'; btnSnap.style.display = 'block';
            } catch (e) { showNotif("Kamera Bermasalah"); }
        }
    }

    function takePhoto() {
        const vid = document.getElementById('camera-preview');
        const canvas = document.getElementById('hidden-canvas');
        const loader = document.getElementById('loader');
        canvas.width = vid.videoWidth; canvas.height = vid.videoHeight;
        canvas.getContext('2d').drawImage(vid, 0, 0);
        loader.style.display = 'block';
        Tesseract.recognize(canvas.toDataURL(), 'eng').then(({ data: { text } }) => {
            const match = text.match(/\d+/); 
            if (match) { 
                document.getElementById('searchKode').value = match[0]; 
                doSearch(); 
                toggleCam();
            }
        }).finally(() => { loader.style.display = 'none'; });
    }

    function clearAll() {
        if(confirm("Hapus seluruh database?")) { 
            db = []; localStorage.removeItem('mbData'); refreshTable(); 
            showNotif("Database dikosongkan");
        }
    }

    window.onload = refreshTable;
</script>
</body>
</html>
